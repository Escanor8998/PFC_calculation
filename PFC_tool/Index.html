<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFC CALCULATOR</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .upload-section {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-upload {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            margin: 0 auto;
            max-width: 600px;
        }
        
        .file-upload:hover {
            border-color: #3498db;
            background: #e8f4fc;
        }
        
        .file-upload h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .file-upload p {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 14px;
        }
        
        .input-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .input-section h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .criteria-section {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fc;
            border-radius: 8px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .calculate-btn {
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            font-size: 18px;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .optimal-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: transform 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
        }
        
        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dotted #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .result-value {
            color: #e74c3c;
        }
        
        .success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .progress-container {
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .design-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .design-option {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .design-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .design-option.selected {
            border-color: #3498db;
            background-color: #e8f4fc;
        }
        
        .design-option.invalid-window {
            border-color: #e74c3c;
            background-color: #fdeaea;
        }
        
        .design-option h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .option-score {
            display: inline-block;
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .option-cost {
            display: inline-block;
            padding: 5px 10px;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
            margin-left: 5px;
        }
        
        .cost-cheap {
            background: #27ae60;
        }
        
        .cost-balance {
            background: #f39c12;
        }
        
        .cost-expensive {
            background: #e74c3c;
        }
        
        .window-warning {
            color: #e74c3c;
            font-weight: 600;
            margin-top: 10px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .design-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PFC CALCULATOR</h1>
            <p class="description">Upload a CSV file containing both material and core data. The system will automatically calculate and find the optimal design.</p>
        </header>
        
        <section class="upload-section">
            <div class="file-upload">
                <h3>CSV Data File</h3>
                <p>Columns 1-9: Material data (Name, µ, a, b, c, x, y, z, t)<br>
                   Column 10: Material cost (≥1)<br>
                   Columns 11-17: Core data (Name, OD, ID, Ht, le, Ae, Ve)<br>
                   Column 18: Window section (cm²)</p>
                <input type="file" id="dataFile" accept=".csv">
                <p class="file-info" id="fileInfo">Loading default file "Data.csv"...</p>
                <button id="loadDefaultBtn" style="margin-top: 10px;">Load Default File</button>
            </div>
        </section>
        
        <section class="input-section">
            <h2>Input Parameters</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="current">Current (Irms)</label>
                    <input type="number" id="current" placeholder="Enter Irms (A)" step="0.1" value="2.5">
                </div>
                
                <div class="input-group">
                    <label for="currentPP">Peak-to-Peak Current (Ipp)</label>
                    <input type="number" id="currentPP" placeholder="Enter Ipp (A)" step="0.1" value="5.0">
                </div>
                
                <div class="input-group">
                    <label for="frequency">Frequency (F)</label>
                    <input type="number" id="frequency" placeholder="Enter frequency (Hz)" value="100000">
                </div>
                
                <div class="input-group">
                    <label for="wireDia">Wire Diameter (mm)</label>
                    <input type="number" id="wireDia" placeholder="Enter wire diameter" step="0.01" value="0.5">
                </div>
                
                <div class="input-group">
                    <label for="wireType">Wire Type</label>
                    <select id="wireType">
                        <option value="single">Single Wire</option>
                        <option value="parallel">Parallel Wires</option>
                    </select>
                </div>
            </div>
            
            <div class="criteria-section">
                <h3>Optimization Criteria</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="targetLoadL">Load (rms) Inductance (µH)</label>
                        <input type="number" id="targetLoadL" placeholder="Enter target LoadL" step="0.0001" value="1000">
                    </div>
                    
                    <div class="input-group">
                        <label for="targetNoLoadL">No Load Inductance (µH)</label>
                        <input type="number" id="targetNoLoadL" placeholder="Enter target NoLoadL" step="0.0001" value="2000">
                    </div>
                    
                    <div class="input-group">
                        <label for="maxHeight">Maximum Height (mm)</label>
                        <input type="number" id="maxHeight" placeholder="Enter max height" step="0.1" value="30.0">
                    </div>
                    
                    <div class="input-group">
                        <label for="maxSize">Maximum Size (mm)</label>
                        <input type="number" id="maxSize" placeholder="Enter max size" step="0.1" value="40.0">
                    </div>
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <p id="progressText">Calculating... 0%</p>
            </div>
            
            <button class="calculate-btn" id="calculateBtn">Find Optimal Design</button>
        </section>
        
        <section class="results-section">
            <h2>Optimal Design Results</h2>
            <div id="noResults">Please upload a CSV file and enter parameters to see calculation results.</div>
            
            <div class="design-options" id="qualityOptions" style="display: none;">
                <!-- 3 quality design options will be inserted here -->
            </div>
            
            <div class="optimal-results" id="optimalResults" style="display: none;">
                <div class="result-card">
                    <h3>Basic Parameters</h3>
                    <div class="result-item">
                        <span class="result-name">Material:</span>
                        <span class="result-value" id="optMaterial">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Core:</span>
                        <span class="result-value" id="optCore">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Turns:</span>
                        <span class="result-value" id="optTurns">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Wire Diameter:</span>
                        <span class="result-value" id="optWireDia">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Wire Type:</span>
                        <span class="result-value" id="optWireType">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Stacks:</span>
                        <span class="result-value" id="optStack">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Window Fill:</span>
                        <span class="result-value" id="optWindowFill">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Material Cost:</span>
                        <span class="result-value" id="optMaterialCost">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Copper Cost:</span>
                        <span class="result-value" id="optCopperCost">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Total Cost:</span>
                        <span class="result-value" id="optTotalCost">-</span>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>Electrical Results</h3>
                    <div class="result-item">
                        <span class="result-name">LoadL:</span>
                        <span class="result-value" id="optLoadL">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">NoLoadL:</span>
                        <span class="result-value" id="optNoLoadL">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Current Density:</span>
                        <span class="result-value" id="optCurrentDensity">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Copper Loss:</span>
                        <span class="result-value" id="optCopperLoss">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Core Loss:</span>
                        <span class="result-value" id="optCoreLoss">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Total Loss:</span>
                        <span class="result-value" id="optTotalLoss">-</span>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>Dimensions</h3>
                    <div class="result-item">
                        <span class="result-name">Length:</span>
                        <span class="result-value" id="optLength">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Width:</span>
                        <span class="result-value" id="optWidth">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Height:</span>
                        <span class="result-value" id="optHeight">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Inductance (AL):</span>
                        <span class="result-value" id="optAL">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-name">Flux Density (B):</span>
                        <span class="result-value" id="optB">-</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

<script>
    // Variables to store data from CSV file
    let materialData = [];
    let coreData = [];
    
    // Set default values for copper price and density
    const DEFAULT_COPPER_PRICE = 9.50; // $/kg
    const DEFAULT_COPPER_DENSITY = 8.96; // g/cm³
    
    // Load default CSV file when page loads
    window.addEventListener('DOMContentLoaded', function() {
        loadDefaultCSV();
    });
    
    // Handle file upload event
    document.getElementById('dataFile').addEventListener('change', function(e) {
        handleFileUpload(e.target.files[0]);
    });
    
    // Handle load default file button
    document.getElementById('loadDefaultBtn').addEventListener('click', function() {
        loadDefaultCSV();
    });
    
    // Function to load default CSV file
    function loadDefaultCSV() {
        document.getElementById('fileInfo').innerHTML = '<span>Loading default file "Data.csv"...</span>';
        
        fetch('Data.csv')
            .then(response => {
                if (!response.ok) {
                    throw new Error('File not found');
                }
                return response.text();
            })
            .then(data => {
                parseCSVData(data);
                document.getElementById('fileInfo').innerHTML = '<span class="success">Default file "Data.csv" loaded successfully</span>';
            })
            .catch(error => {
                console.error('Error loading default CSV file:', error);
                document.getElementById('fileInfo').innerHTML = '<span class="error">Error loading default file: ' + error.message + '</span>';
            });
    }
    
    // File upload handler
    function handleFileUpload(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            parseCSVData(content);
            document.getElementById('fileInfo').innerHTML = `<span class="success">Uploaded: ${file.name}</span>`;
        };
        
        reader.readAsText(file);
    }
    
    // Parse CSV data and populate materialData and coreData arrays
    function parseCSVData(content) {
        const lines = content.split('\n');
        materialData = [];
        coreData = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line) {
                const values = line.split(',');
                
                // Extract material data (columns 1-10)
                if (values.length >= 10) {
                    const materialValues = values.slice(0, 10);
                    materialData.push(materialValues);
                }
                
                // Extract core data (columns 11-18)
                if (values.length >= 18) {
                    const coreValues = values.slice(10, 18);
                    coreData.push(coreValues);
                }
            }
        }
        
        console.log(`Loaded ${materialData.length} materials and ${coreData.length} cores`);
    }
    
    // Handle calculate button click
    document.getElementById('calculateBtn').addEventListener('click', function() {
        const Irms = parseFloat(document.getElementById('current').value);
        const Ipp = parseFloat(document.getElementById('currentPP').value);
        const frequency = parseFloat(document.getElementById('frequency').value);
        const wireDia = parseFloat(document.getElementById('wireDia').value);
        const wireType = document.getElementById('wireType').value;
        
        // Convert from µH to H
        const targetLoadL = parseFloat(document.getElementById('targetLoadL').value) / 1000000;
        const targetNoLoadL = parseFloat(document.getElementById('targetNoLoadL').value) / 1000000;
        const maxHeight = parseFloat(document.getElementById('maxHeight').value);
        const maxSize = parseFloat(document.getElementById('maxSize').value);
        
        if (!Irms || !Ipp || !frequency || !wireDia || !targetLoadL || !targetNoLoadL || !maxHeight || !maxSize) {
            alert('Please enter all input parameters and optimization criteria');
            return;
        }
        
        if (materialData.length === 0 || coreData.length === 0) {
            alert('Please upload a CSV file with both material and core data');
            return;
        }
        
        // Show progress bar
        document.getElementById('progressContainer').style.display = 'block';
        
        // Calculate and find optimal design
        setTimeout(() => {
            findOptimalDesign(Irms, Ipp, frequency, wireDia, wireType, DEFAULT_COPPER_PRICE, DEFAULT_COPPER_DENSITY,
                            targetLoadL, targetNoLoadL, maxHeight, maxSize);
        }, 100);
    });
    
    // Function to find optimal design
    function findOptimalDesign(Irms, Ipp, F, wireDia, wireType, copperPrice, copperDensity,
                             targetLoadL, targetNoLoadL, maxHeight, maxSize) {
        const totalCombinations = materialData.length * coreData.length * 100 * 10; // 100 turns, 10 stacks
        let currentCombination = 0;
        let allDesigns = [];
        
        // Iterate through all materials and cores
        for (let m = 0; m < materialData.length; m++) {
            const material = materialData[m];
            
            // Skip materials without cost data
            if (material.length < 10 || !material[9] || isNaN(parseFloat(material[9])) || parseFloat(material[9]) < 1) {
                continue;
            }
            
            for (let c = 0; c < coreData.length; c++) {
                const core = coreData[c];
                
                // Skip cores without window section data
                if (core.length < 8 || !core[7] || isNaN(parseFloat(core[7]))) {
                    continue;
                }
                
                // Scan through turns from 1 to 100
                for (let N = 1; N <= 100; N++) {
                    // Scan through stacks from 1 to 10
                    for (let stack = 1; stack <= 10; stack++) {
                        // Update progress
                        currentCombination++;
                        const progress = Math.round((currentCombination / totalCombinations) * 100);
                        document.getElementById('progressBar').style.width = `${progress}%`;
                        document.getElementById('progressText').textContent = `Calculating... ${progress}%`;
                        
                        // Check data validity
                        if (material.length < 10 || core.length < 8) continue;
                        
                        try {
                            // Calculate design
                            const design = calculateDesign(Irms, Ipp, F, N, stack, wireDia, wireType, copperPrice, copperDensity, m, c);
                            
                            // Check constraints
                            if (design.height > maxHeight) continue;
                            if (design.L_W > maxSize) continue;
                            
                            // Check window fill constraint
                            const windowSection = parseFloat(core[7]); // cm²
                            const wireCrossSection = Math.PI * Math.pow(wireDia / 20, 2); // cm² (wireDia in mm, convert to cm)
                            
                            // Adjust for parallel wires
                            const parallelFactor = wireType === 'parallel' ? 2 : 1;
                            const totalWireArea = N * wireCrossSection * parallelFactor; // cm²
                            
                            const windowFillRatio = totalWireArea / windowSection;
                            
                            if (windowFillRatio > 0.4) {
                                design.windowFillValid = false;
                                design.windowFillRatio = windowFillRatio;
                            } else {
                                design.windowFillValid = true;
                                design.windowFillRatio = windowFillRatio;
                            }
                            
                            // Calculate evaluation score (LoadL is most important, then NoLoadL, then size)
                            const loadLScore = Math.abs(design.loadL - targetLoadL) / targetLoadL;
                            const noLoadLScore = Math.abs(design.noLoadL - targetNoLoadL) / targetNoLoadL;
                            const sizeScore = (design.L_W + design.height) / (maxSize + maxHeight);
                            
                            // Penalize designs with invalid window fill
                            const windowFillPenalty = design.windowFillValid ? 1 : 2;
                            
                            // Weights: LoadL (50%), NoLoadL (30%), size (20%)
                            const totalScore = windowFillPenalty * (0.5 * loadLScore + 0.3 * noLoadLScore + 0.2 * sizeScore);
                            
                            // Save design and score
                            design.score = totalScore;
                            design.loadLScore = loadLScore;
                            design.noLoadLScore = noLoadLScore;
                            design.sizeScore = sizeScore;
                            
                            allDesigns.push(design);
                        } catch (e) {
                            console.error("Calculation error:", e);
                        }
                    }
                }
            }
        }
        
        // Hide progress bar
        document.getElementById('progressContainer').style.display = 'none';
        
        // Sort designs by score (low to high) for quality
        const qualityDesigns = [...allDesigns].sort((a, b) => a.score - b.score);
        
        // Display top 3 quality options
        if (qualityDesigns.length > 0) {
            displayDesignOptions(qualityDesigns.slice(0, 3));
        } else {
            document.getElementById('noResults').innerHTML = '<p class="error">No suitable designs found with the given criteria. Please adjust parameters and try again.</p>';
        }
    }
    
    // Function to calculate design
    function calculateDesign(Irms, Ipp, F, N, stack, wireDia, wireType, copperPrice, copperDensity, materialIndex, coreIndex) {
        // Get data from uploaded arrays
        const material = materialData[materialIndex];
        const core = coreData[coreIndex];
        
        // Get values from data
        const materialName = material[0];
        const mu = parseFloat(material[1]);
        const a = parseFloat(material[2]);
        const b = parseFloat(material[3]);
        const c_val = parseFloat(material[4]);
        const x = parseFloat(material[5]);
        const y = parseFloat(material[6]);
        const z = parseFloat(material[7]);
        const t_val = parseFloat(material[8]);
        const materialCostPerCm3 = parseFloat(material[9]);
        
        const coreName = core[0];
        const OD = parseFloat(core[1]);
        const ID = parseFloat(core[2]);
        const Ht = parseFloat(core[3]);
        const le = parseFloat(core[4]); // cm
        const Ae = parseFloat(core[5]); // cm²
        const Ve = parseFloat(core[6]); // cm³
        const windowSection = parseFloat(core[7]); // cm²
        
        // Tạo định dạng core mới: CORE (ODxIDxHt)
        const coreFormatted = `${coreName} (${OD}x${ID}x${Ht})`;
        
        // Calculate effective Ae with stacked cores
        const effectiveAe = Ae * stack;
        
        // Adjust for parallel wires
        const parallelFactor = wireType === 'parallel' ? 2 : 1;
        const effectiveWireDia = wireType === 'parallel' ? wireDia * Math.sqrt(2) : wireDia;
        
        // Perform calculations with adjusted units
        const MTL = 4 * effectiveWireDia + OD - ID + Ht * 2 * stack; // mm
        const wireLength = MTL * N / 1000 + 0.02; // convert to meters
        const wireArea = Math.PI * Math.pow(wireDia / 2, 2);
        const DCR = 0.0168 * wireLength / (wireArea * parallelFactor); // Ω
        
        const H = 0.4 * Math.PI * N * Irms / (le); // le from cm to mm, result in Oe
        const percentMu = 100 / (a + b * Math.pow(H, c_val));
        const AL = 4 * Math.PI * Math.pow(10, -7) * mu * (effectiveAe * 0.0001) / (le * 0.01); // Ae from cm² to m², le from cm to m
        const noLoadL = AL * Math.pow(N, 2);
        const loadL = percentMu / 100 * noLoadL;
        const copperLoss = DCR * Math.pow(Irms, 2);
        const B = loadL * Ipp / 2 / N / (effectiveAe * 0.0001); // Ae from cm² to m², result in Tesla
        const coreLoss = (Math.pow(B * 10, x)) * (y * (F / 1000) + z * Math.pow(F / 1000, t_val)) * Ve / 1000 * stack;
        const L_W = OD + 2 * effectiveWireDia + 1; // mm
        const height = Ht * stack + 2 * effectiveWireDia + 1; // mm
        
        // Calculate current density (A/mm²)
        const currentDensity = Irms / (wireArea * parallelFactor);
        
        // Calculate copper weight and cost
        const copperVolume = wireLength * Math.PI * Math.pow(wireDia / 2 / 10, 2) * parallelFactor; // cm³
        const copperWeight = copperVolume * copperDensity; // grams
        const copperCost = copperWeight * copperPrice / 1000; // convert grams to kg
        
        // Calculate material cost (material cost * core volume * stack)
        const materialCost = materialCostPerCm3 * Ve * stack;
        
        // Calculate total cost
        const totalCost = materialCost + copperCost;
        
        return {
            material: materialName,
            core: coreName,
            coreFormatted: coreFormatted,
            materialIndex: materialIndex,
            coreIndex: coreIndex,
            wireDia: wireDia,
            wireType: wireType,
            turns: N,
            stack: stack,
            MTL: MTL / 1000, // convert to meters
            wireLength: wireLength,
            DCR: DCR,
            H: H,
            percentMu: percentMu,
            AL: AL,
            noLoadL: noLoadL,
            loadL: loadL,
            copperLoss: copperLoss,
            B: B,
            coreLoss: coreLoss,
            L_W: L_W,
            height: height,
            totalLoss: copperLoss + coreLoss,
            currentDensity: currentDensity,
            materialCost: materialCost,
            copperCost: copperCost,
            totalCost: totalCost,
            windowSection: windowSection
        };
    }
    
    // Function to display design options
    function displayDesignOptions(qualityDesigns) {
        document.getElementById('noResults').style.display = 'none';
        
        const qualityContainer = document.getElementById('qualityOptions');
        
        qualityContainer.style.display = 'grid';
        qualityContainer.innerHTML = '';
        
        // Find the min and max costs for comparison
        const costs = qualityDesigns.map(d => d.totalCost);
        const minCost = Math.min(...costs);
        const maxCost = Math.max(...costs);
        
        // Display quality options
        qualityDesigns.forEach((design, index) => {
            // Determine cost category based on comparison with other designs
            let costCategory = '';
            let costClass = '';
            
            if (design.totalCost === minCost) {
                costCategory = 'Cheap';
                costClass = 'cost-cheap';
            } else if (design.totalCost === maxCost) {
                costCategory = 'Expensive';
                costClass = 'cost-expensive';
            } else {
                costCategory = 'Balance';
                costClass = 'cost-balance';
            }
            
            const optionDiv = createOptionDiv(design, index, costCategory, costClass);
            qualityContainer.appendChild(optionDiv);
        });
        
        // Auto-select first quality option
        if (qualityContainer.firstChild) {
            qualityContainer.firstChild.click();
        }
    }
    
    // Helper function to create option div
    function createOptionDiv(design, index, costCategory, costClass) {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'design-option';
        if (!design.windowFillValid) {
            optionDiv.classList.add('invalid-window');
        }
        optionDiv.dataset.index = index;
        
        // Determine the rank text
        const rankText = ['1st Quality', '2nd Quality', '3rd Quality'][index];
        const wireTypeText = design.wireType === 'parallel' ? 'Parallel Wires' : 'Single Wire';
        
        optionDiv.innerHTML = `
            <span class="option-score">${rankText}</span>
            <span class="option-cost ${costClass}">${costCategory}</span>
            ${!design.windowFillValid ? '<div class="window-warning">⚠️ Window fill exceeds 40%</div>' : ''}
            <h3>${rankText}</h3>
            <div class="result-item">
                <span class="result-name">Material:</span>
                <span class="result-value">${design.material}</span>
            </div>
            <div class="result-item">
                <span class="result-name">Core:</span>
                <span class="result-value">${design.coreFormatted}</span>
            </div>
            <div class="result-item">
                <span class="result-name">Turns:</span>
                <span class="result-value">${design.turns}</span>
            </div>
            <div class="result-item">
                <span class="result-name">Wire Type:</span>
                <span class="result-value">${wireTypeText}</span>
            </div>
            <div class="result-item">
                <span class="result-name">Stacks:</span>
                <span class="result-value">${design.stack}</span>
                       </div>
            <div class="result-item">
                <span class="result-name">LoadL:</span>
                <span class="result-value">${(design.loadL * 1000000).toFixed(2)} µH</span>
            </div>
            <div class="result-item">
                <span class="result-name">NoLoadL:</span>
                <span class="result-value">${(design.noLoadL * 1000000).toFixed(2)} µH</span>
            </div>
            <div class="result-item">
                <span class="result-name">Total Cost:</span>
                <span class="result-value">$${design.totalCost.toFixed(2)}</span>
            </div>
            <div class="result-item">
                <span class="result-name">Total Loss:</span>
                <span class="result-value">${design.totalLoss.toFixed(4)} W</span>
            </div>
            <div class="result-item">
                <span class="result-name">Window Fill:</span>
                <span class="result-value ${design.windowFillValid ? 'success' : 'error'}">${(design.windowFillRatio * 100).toFixed(1)}%</span>
            </div>
        `;
        
        // Add click event to select this option
        optionDiv.addEventListener('click', function() {
            // Remove selected class from all options
            document.querySelectorAll('.design-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            // Display detailed results for this design
            displayDetailedResults(design);
        });
        
        return optionDiv;
    }
    
    // Function to display detailed results for selected design
    function displayDetailedResults(design) {
        document.getElementById('optimalResults').style.display = 'grid';
        
        // Format values for display
        const wireTypeText = design.wireType === 'parallel' ? 'Parallel Wires' : 'Single Wire';
        
        // Update basic parameters
        document.getElementById('optMaterial').textContent = design.material;
        document.getElementById('optCore').textContent = design.coreFormatted;
        document.getElementById('optTurns').textContent = design.turns;
        document.getElementById('optWireDia').textContent = `${design.wireDia} mm`;
        document.getElementById('optWireType').textContent = wireTypeText;
        document.getElementById('optStack').textContent = design.stack;
        document.getElementById('optWindowFill').innerHTML = `<span class="${design.windowFillValid ? 'success' : 'error'}">${(design.windowFillRatio * 100).toFixed(1)}%</span>`;
        document.getElementById('optMaterialCost').textContent = `$${design.materialCost.toFixed(2)}`;
        document.getElementById('optCopperCost').textContent = `$${design.copperCost.toFixed(2)}`;
        document.getElementById('optTotalCost').textContent = `$${design.totalCost.toFixed(2)}`;
        
        // Update electrical results
        document.getElementById('optLoadL').textContent = `${(design.loadL * 1000000).toFixed(2)} µH`;
        document.getElementById('optNoLoadL').textContent = `${(design.noLoadL * 1000000).toFixed(2)} µH`;
        document.getElementById('optCurrentDensity').textContent = `${design.currentDensity.toFixed(2)} A/mm²`;
        document.getElementById('optCopperLoss').textContent = `${design.copperLoss.toFixed(4)} W`;
        document.getElementById('optCoreLoss').textContent = `${design.coreLoss.toFixed(4)} W`;
        document.getElementById('optTotalLoss').textContent = `${design.totalLoss.toFixed(4)} W`;
        
        // Update dimensions
        document.getElementById('optLength').textContent = `${design.L_W.toFixed(2)} mm`;
        document.getElementById('optWidth').textContent = `${design.L_W.toFixed(2)} mm`;
        document.getElementById('optHeight').textContent = `${design.height.toFixed(2)} mm`;
        document.getElementById('optAL').textContent = `${design.AL.toFixed(8)} H/turn²`;
        document.getElementById('optB').textContent = `${(design.B * 1000).toFixed(2)} mT`;
    }
</script>
</body>
</html>